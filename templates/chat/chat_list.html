<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chat</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .message-box {
            border-radius: 10px;
            padding: 8px 12px;
            max-width: 70%;
        }

        .receiver-message {
            background-color: #e2e2e2;
            align-self: flex-start;
        }

        .sender-message {
            background-color: #dcf8c6;
            align-self: flex-end;
        }

        .input-group {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-4">
                <h1>List of Receivers</h1>
                <ul class="list-group" id="receiver-list">
                    <!-- Receiver list items -->
                </ul>
            </div>
            <div class="col-md-8">
                <div class="card chat-container">
                    <div class="card-header">
                        Chat Interface
                    </div>
                    <div class="card-body message-container" id="message-container">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" id="id_message_send_input" class="form-control" placeholder="Type a message...">
                            <button id="id_message_send_button" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
   
    <script>
        let chatSocket = null;
        const senderUsername = "{{ request.user.email }}";
        let receiverUsername = null;

        function startChat(receiver) {
            receiverUsername = receiver;
            console.log('receiverUsername-----here------', receiverUsername);
            const chatRoomName = `group_chat_${senderUsername}_${receiverUsername}`;
            console.log('chatRoomName----111---', chatRoomName);

            if (chatSocket !== null && chatSocket.readyState === WebSocket.OPEN) {
                if (chatSocket.roomName === chatRoomName) {
                    console.log('Already connected to this chat room.');
                    return;
                } else {
                    chatSocket.close();
                }
            }

            chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${senderUsername}/${receiverUsername}/`);
            chatSocket.roomName = chatRoomName;
            console.log('chatSocket.roomName-----', chatSocket.roomName, chatSocket);

            chatSocket.onopen = function (e) {
                console.log("The connection was set up successfully!");
            };

            // chatSocket.onmessage = function (e) {
            //     const data = JSON.parse(e.data);
            //     console.log('----data----00----', data);

            //     const messageContainer = document.querySelector("#message-container");
            //     const messageElement = document.createElement("div");
            //     messageElement.classList.add("message");

            //     const senderUsername = data.sender_username;
            //     console.log('senderUsername---111---', senderUsername);
            //     const receiverUsername = data.receiver_username;
            //     console.log('receiverUsername----222--', receiverUsername);
            //     const username = data.username;
            //     console.log('----username-------333--', username);
            //     const message = data.message;
            //     console.log('------message------444--', message);

            //     if (receiverUsername === "{{ request.user.email }}") {
            //         messageElement.classList.add("receiver-message");
            //         messageElement.innerHTML = `<span class="username">${senderUsername}:</span><br> <sapn>${message}</span>`;
            //     } else {
            //         messageElement.classList.add("sender-message");
            //         messageElement.innerHTML = `<span class="username">${senderUsername}:</span><br> <sapn>${message}</span>`;
            //     }

            //     messageContainer.appendChild(messageElement);
            // };


            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);

                const messageContainer = document.querySelector("#message-container");
                const messageElement = document.createElement("div");
                messageElement.classList.add("message-container");

                const senderUsername = data.sender_username;
                const receiverUsername = data.receiver_username;
                const message = data.message;

                if (receiverUsername === "{{ request.user.email }}") {
                    messageElement.classList.add("receiver-message");
                    messageElement.innerHTML = `
                        <div class="message-box">
                            <span class="username">${senderUsername}:</span><br>
                            <span>${message}</span>
                        </div>`;
                } else {
                    messageElement.classList.add("sender-message");
                    messageElement.innerHTML = `
                        <div class="message-box">
                            <span class="username">${senderUsername}:</span><br>
                            <span>${message}</span>
                        </div>`;
                }

                messageContainer.appendChild(messageElement);
            };





            chatSocket.onclose = function (e) {
                console.log("The connection was closed unexpectedly!");
            };

            chatSocket.onerror = function (error) {
                console.error('WebSocket Error: ', error);
            };

            document.querySelector("#id_message_send_input").focus();
            document.querySelector("#id_message_send_input").onkeyup = function (e) {
                if (e.keyCode == 13) {
                    document.querySelector("#id_message_send_button").click();
                }
            };

            document.querySelector("#id_message_send_button").onclick = function (e) {
                var messageInput = document.querySelector("#id_message_send_input").value;
                chatSocket.send(JSON.stringify({ message: messageInput, username: senderUsername }));
                document.querySelector("#id_message_send_input").value = "";
            };
        }
    </script>



</body>
</html>


































































<!-- 


<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chat</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <h1>List of Receivers</h1>
    <ul>
        {% for receiver in receiver_users %}
            <li><a href="#" onclick="startChat('{{ receiver.email }}')">{{ receiver.email }}</a></li>
        {% endfor %}
    </ul>

    <div id="message-container">
      
    </div>
    
    <input type="text" id="id_message_send_input" />
    <button id="id_message_send_button">Send</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        let chatSocket = null;
        const senderUsername = "{{ request.user.email }}";
        let receiverUsername = null;

        function startChat(receiver) {
            receiverUsername = receiver;
            console.log('receiverUsername-----here------', receiverUsername);
            const chatRoomName = `group_chat_${senderUsername}_${receiverUsername}`;
            console.log('chatRoomName----111---', chatRoomName);

            if (chatSocket !== null && chatSocket.readyState === WebSocket.OPEN) {
                if (chatSocket.roomName === chatRoomName) {
                    console.log('Already connected to this chat room.');
                    return;
                } else {
                    chatSocket.close();
                }
            }

            chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${senderUsername}/${receiverUsername}/`);
            chatSocket.roomName = chatRoomName;
            console.log('chatSocket.roomName-----', chatSocket.roomName, chatSocket);

            chatSocket.onopen = function (e) {
                console.log("The connection was set up successfully!");
            };

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log('----data----00----', data);

                const messageContainer = document.querySelector("#message-container");
                const messageElement = document.createElement("div");
                messageElement.classList.add("message");

                const senderUsername = data.sender_username;
                console.log('senderUsername---111---', senderUsername);
                const receiverUsername = data.receiver_username;
                console.log('receiverUsername----222--', receiverUsername);
                const username = data.username;
                console.log('----username-------333--', username);
                const message = data.message;
                console.log('------message------444--', message);

                if (receiverUsername === "{{ request.user.email }}") {
                    messageElement.classList.add("receiver-message");
                    messageElement.innerHTML = `<span class="username">${senderUsername}:</span> ${message}`;
                } else {
                    messageElement.classList.add("sender-message");
                    messageElement.innerHTML = `<span class="username">${senderUsername}:</span> ${message}`;
                }

                messageContainer.appendChild(messageElement);
            };

            chatSocket.onclose = function (e) {
                console.log("The connection was closed unexpectedly!");
            };

            chatSocket.onerror = function (error) {
                console.error('WebSocket Error: ', error);
            };

            document.querySelector("#id_message_send_input").focus();
            document.querySelector("#id_message_send_input").onkeyup = function (e) {
                if (e.keyCode == 13) {
                    document.querySelector("#id_message_send_button").click();
                }
            };

            document.querySelector("#id_message_send_button").onclick = function (e) {
                var messageInput = document.querySelector("#id_message_send_input").value;
                chatSocket.send(JSON.stringify({ message: messageInput, username: senderUsername }));
                document.querySelector("#id_message_send_input").value = "";
            };
        }
    </script>
    <style>
        .receiver-message {
            color: blue; /* Style for receiver's messages */
        }
        .sender-message {
            color: green; /* Style for sender's messages */
        }
    </style>
</body>
</html> -->



